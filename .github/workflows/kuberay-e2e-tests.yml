name: Test KubeRay Operator E2E Tests

on:
  repository_dispatch:
    types: [branch-dispatch-e2e-post-merge]

jobs:
  run_kuberay_post_merge_e2e_tests:
    runs-on: kuberay-testing # target runner
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone KubeRay repository
        run: |
          git clone --depth=1 --branch dev https://github.com/opendatahub-io/kuberay.git

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          cache: false
          go-version: '1.24'

      - name: Set up gotestfmt
        uses: gotesttools/gotestfmt-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Setup Kind Cluster with KubeRay Helm Repo
        uses: ./.github/actions/setup-kind-cluster

      - name: Deploy Kuberay operator
        id: deploy
        run: |
          echo "Deploying Kuberay operator"
          cd kuberay/ray-operator

          IMG=quay.io/opendatahub/kuberay-operator:dev
          make docker-build -e IMG="${IMG}" -e ENGINE=docker
          kind load docker-image ${IMG}

          make deploy -e IMG="${IMG}"
          kubectl wait --timeout=90s --for=condition=Available=true deployment -n default kuberay-operator


      - name: Start namespace cleanup script
        if: steps.deploy.outcome == 'success'
        run: |
          # Start background namespace cleanup to prevent stuck terminating namespaces
          {
            echo "Starting namespace cleanup script..."
            kubectl proxy &
            PROXY_PID=$!
            sleep 3

            trap "kill $PROXY_PID 2>/dev/null" EXIT

            while true; do
              terminating_ns=$(kubectl get namespaces --field-selector status.phase=Terminating -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)

              if [ -z "$terminating_ns" ]; then
                echo "$(date): No namespaces in Terminating state, waiting..."
              else
                for ns in $terminating_ns; do
                  echo "$(date): Cleaning up namespace: $ns"
                  
                  # FIRST: Remove finalizers from Ray CRDs (this is what blocks deletion)
                  for resource in rayclusters.ray.io rayservices.ray.io rayjobs.ray.io; do
                    for name in $(kubectl get "$resource" -n "$ns" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
                      echo "  Removing finalizers from $resource/$name"
                      timeout 10s kubectl patch "$resource" "$name" -n "$ns" --type=json -p='[{"op":"remove","path":"/metadata/finalizers"}]' 2>/dev/null || true
                    done
                  done
                  
                  # SECOND: Remove finalizers from pods
                  for pod in $(kubectl get pods -n "$ns" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
                    timeout 5s kubectl patch pod "$pod" -n "$ns" --type=json -p='[{"op":"remove","path":"/metadata/finalizers"}]' 2>/dev/null || true
                  done
                  
                  # THIRD: Quick delete attempts (should be instant now that finalizers are gone)
                  timeout 10s kubectl delete pods --all -n "$ns" --force --grace-period=0 --wait=false 2>/dev/null || true
                  timeout 10s kubectl delete all --all -n "$ns" --force --grace-period=0 --wait=false 2>/dev/null || true

                  # Finalize the namespace via API
                  echo "$(date): Finalizing namespace: $ns"
                  kubectl get namespace "$ns" -o json 2>/dev/null | jq '.spec = {"finalizers":[]}' > /tmp/finalize-$ns.json
                  curl_result=$(curl -s -k -H "Content-Type: application/json" -X PUT --data-binary @/tmp/finalize-$ns.json "127.0.0.1:8001/api/v1/namespaces/$ns/finalize" 2>&1)
                  echo "  Finalize result: $curl_result"
                  rm -f /tmp/finalize-$ns.json
                  
                  echo "$(date): Done with $ns"
                done
              fi

              sleep 3
            done
          } > ./namespace-cleanup.log 2>&1 &
          echo $! > ./cleanup-pid.txt
          echo "Namespace cleanup started with PID $(cat ./cleanup-pid.txt)"

      - name: Run e2e tests (excluding TestRayJobRecovery) - First attempt
        if: steps.deploy.outcome == 'success'
        id: first_run
        continue-on-error: true
        run: |
          export KUBERAY_TEST_TIMEOUT_SHORT=7m KUBERAY_TEST_TIMEOUT_MEDIUM=12m KUBERAY_TEST_TIMEOUT_LONG=15m KUBERAY_TEST_RAY_IMAGE=rayproject/ray:2.52.1

          set -euo pipefail
          cd kuberay/ray-operator
          go test -timeout 120m -v ./test/e2e -skip "TestRayJobRecovery" -json 2>&1 | tee ./gotest.log | gotestfmt

      - name: Extract failed tests and retry
        if: steps.deploy.outcome == 'success' && steps.first_run.outcome == 'failure'
        run: |
          export KUBERAY_TEST_TIMEOUT_SHORT=5m KUBERAY_TEST_TIMEOUT_MEDIUM=12m KUBERAY_TEST_TIMEOUT_LONG=15m KUBERAY_TEST_RAY_IMAGE=rayproject/ray:2.52.1

          cd kuberay/ray-operator
          
          # Extract failed test names from the JSON output
          # Only get the most specific failed tests (subtests, not parent tests)
          all_failed_tests=$(grep -E '"Action":"(fail|skip)"' ./gotest.log | jq -r 'select(.Test != null and .Test != "") | .Test' | grep -v '^null$' | sort -u)
          
          # Filter to get only the most specific tests (those with "/" are subtests)
          # If a subtest failed, don't include its parent test
          failed_tests=""
          while IFS= read -r test; do
            if [[ "$test" == *"/"* ]]; then
              # This is a subtest, include it
              if [ -n "$failed_tests" ]; then
                failed_tests="$failed_tests"$'\n'"$test"
              else
                failed_tests="$test"
              fi
            else
              # This is a parent test, only include if no subtests of it are already included
              parent_has_subtest=false
              while IFS= read -r existing_test; do
                if [[ "$existing_test" == "$test/"* ]]; then
                  parent_has_subtest=true
                  break
                fi
              done <<< "$failed_tests"
              
              if [ "$parent_has_subtest" = false ]; then
                if [ -n "$failed_tests" ]; then
                  failed_tests="$failed_tests"$'\n'"$test"
                else
                  failed_tests="$test"
                fi
              fi
            fi
          done <<< "$all_failed_tests"
          
          if [ -n "$failed_tests" ]; then
            echo "Found failed tests:"
            echo "$failed_tests"
            
            # Create a regex pattern that matches the exact failed tests
            failed_pattern=""
            while IFS= read -r test; do
              if [ -n "$failed_pattern" ]; then
                failed_pattern="$failed_pattern|"
              fi
              # Escape the test name for regex and ensure exact match
              escaped_test=$(echo "$test" | sed 's/[[\.*^$()+?{|]/\\&/g')
              failed_pattern="$failed_pattern^${escaped_test}$"
            done <<< "$failed_tests"
            
            echo "Retry pattern: $failed_pattern"
            echo "Retrying failed tests..."
            
            # Use gotestsum approach similar to opendatahub-io/kuberay run-tests.sh
            # Create a regex pattern that matches only the specific failed tests
            # Extract unique parent test names (before the "/") for failed subtests
            parent_tests=""
            while IFS= read -r test; do
              if [[ "$test" == *"/"* ]]; then
                # Extract parent test name
                parent_test="${test%%/*}"
                if [[ "$parent_tests" != *"$parent_test"* ]]; then
                  if [ -n "$parent_tests" ]; then
                    parent_tests="$parent_tests|$parent_test"
                  else
                    parent_tests="$parent_test"
                  fi
                fi
              else
                # This is already a parent test
                if [[ "$parent_tests" != *"$test"* ]]; then
                  if [ -n "$parent_tests" ]; then
                    parent_tests="$parent_tests|$test"
                  else
                    parent_tests="$test"
                  fi
                fi
              fi
            done <<< "$failed_tests"
            
            # Create exact match pattern like in run-tests.sh
            if [[ "$parent_tests" == *"|"* ]]; then
              # Multiple tests - create pattern like ^(TestA|TestB)$
              retry_pattern="^($parent_tests)$"
            else
              # Single test - create pattern like ^TestA$
              retry_pattern="^$parent_tests$"
            fi
            
            echo "Retry pattern: $retry_pattern"
            echo "Retrying failed tests using gotestsum..."
            
            # Use gotestsum like in the opendatahub-io/kuberay script
            set -euo pipefail
            gotestsum --format standard-verbose -- -timeout 120m -run "$retry_pattern" ./test/e2e -p 1 -parallel 1 -json 2>&1 | tee ./gotest-retry.log
          else
            echo "No specific failed tests found, but first run failed. This might be a setup/teardown issue."
            exit 1
          fi


      - name: Print debug info
        if: failure()
        run: |
          echo "=== All Pods Status ==="
          kubectl get pods -A -o wide | tee ./debug-pods.log
          
          echo "=== Namespace Status ==="
          kubectl get namespaces -A | tee ./debug-namespaces.log

      - name: Stop namespace cleanup
        if: always()
        run: |
          if [ -f ./cleanup-pid.txt ]; then
            cleanup_pid=$(cat ./cleanup-pid.txt)
            echo "Stopping namespace cleanup (PID: $cleanup_pid)"
            kill $cleanup_pid 2>/dev/null || echo "Cleanup process already stopped"
            sleep 2
          fi

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: kuberay-e2e-logs
          retention-days: 10
          path: |
            **/*.log
            **/gotest*.log
            ./namespace-cleanup.log

      - name: Cleanup Kind Cluster
        if: always()
        uses: ./.github/actions/cleanup-kind-cluster
